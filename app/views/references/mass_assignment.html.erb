<script>
function submit_ma_sqli(target)
{
  $.ajax({
    type:"POST",
    url: target,
    size: $("#ma_sqli")
  }).always(function(msg){
    console.log(msg);
    data = $.parseJSON(msg);
    $("#display").hide();
    $("#display-sql").text();
    $("#display-query").text();

    if(data.result == "success")
    {
      $("#display").removeClass("alert-danger");
      $("#display").addClass("alert-success");
      $("#display-sql").text(unescapeHtml(data.sql));
      $("#display-query").text(unescapeHtml(data.query));
    }
    else
    {
      $("#display").removeClass("alert-success");
      $("#display").addClass("alert-danger");
      $("#display-sql").text("An Error has occured: ");
      $("#display-query").text(unescapeHtml(data.error));
    }

    $("#display").show("fast");
  });
}

function set_listeners()
{
  $("#ma_sqli").keypress(function(event) {
    if(event.keyCode == 13)
    {
      var target = $("#ma_sqli").attr('target');
      submit_ma_sqli(target);
    }
  });

  $("#hint-toggle-link").click(function(){
    $("#hint").toggle();
  });
}

$(document).ready(set_listeners);
</script>
<div class="row">
  <div class="col-xs-12 title">
    <h1>Welcome <%= current_user.name %></h1>
    <h2>Mass Assignment Reference Page</h2>
    <hr/>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div class="input-group well">
      <input type="text" id="ma_sqli" target="mass_assignment_create_chest"
      class="form-control" placeholder="Er... mass assignment dough">
      <span class="input-group-btn">
        <button class="btn btn-default" type="button" onclick="submit_ma_sqli('mass_assignment_create_chest');">send</button>
      </span>
    </div><!-- /input-group -->
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div class="alert alert-success" style="margin-top:0" id="display">
      <p id="display-sql">
      </p>
      <p id="display-query">
      </p>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <div class="panel panel-default">
      <div class="panel-heading text-right">
        <b class="pull-left">Mass Assignment Explanation</b>
        <%= link_to "#", target: "_blank" do %>
          Documentation <span class="glyphicon glyphicon-book"></span>
        <% end %>
      </div>
      <div class="panel-body">
        <p>
          Mass Assignment becomes a vulnerability in different ways depending on
          whether or not you are using strong parameters.
        </p>
        <p>
          <h4>Proper use of mass assignment without strong parameters:</h4>
          <h4>Proper use of mass assignment with strong parameters:</h4>
        </p>
      </div>
      <div class="panel-footer">
        <span class="label label-info clickable" id="hint-toggle-link">Examples</span>
        <div style="display:none;margin-top:10px;" id="hint">
            <p><kbd>Not finished BLARBBLLLARRGH</kbd></p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xs-12 text-center">
    <p><b>Additional Sources</b></p>
    <p><%= link_to "http://blog.remarkablelabs.com/2012/12/strong-parameters-rails-4-countdown-to-2013",
      "http://blog.remarkablelabs.com/2012/12/strong-parameters-rails-4-countdown-to-2013" %></p>
  </div>
</div>
