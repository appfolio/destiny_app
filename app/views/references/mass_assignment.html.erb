<script>
function submit_ma_sqli(target)
{
  //Determine if the request should be sent to the safe or vulnerable action
  if($("#safe_action").hasClass("active"))
  {
    target = "safe_"+target;
  }
  else
  {
    target = "vulnerable_"+target;
  }

  var data = { chest: {} }

  console.log(data)

  if($("#ma_send_size").is(":checked"))data["chest"]["size"]=$("#ma_size").val();
  if($("#ma_send_color").is(":checked"))data["chest"]["color"]=$("#ma_color").val();
  if($("#ma_send_key_slot").is(":checked"))data["chest"]["key_slot"]=$("#ma_key_slot").val();

  $.ajax({
    type:"POST",
    url: target,
    size: $("#ma_size"),
    data: data
  }).always(function(msg){
    console.log(msg);
    data = $.parseJSON(msg);
    $("#display").hide();
    $("#display-sql").text();
    $("#display-query").text();

    if(data.result == "success")
    {
      $("#display").removeClass("alert-danger");
      $("#display").addClass("alert-success");
      $("#display-sql").text(unescapeHtml(data.sql));
      $("#display-query").text(unescapeHtml(data.query));
    }
    else
    {
      $("#display").removeClass("alert-success");
      $("#display").addClass("alert-danger");
      $("#display-sql").text("An Error has occured: ");
      $("#display-query").text(unescapeHtml(data.error));
    }

    $("#display").show("fast");
  });
}
</script>

<div class="row">
  <div class="col-xs-12 title">
    <h1>Welcome <%= current_user.name %></h1>
    <h2>Mass Assignment Reference Page</h2>
  </div>
</div>

<div class="row">
  <div class="col-xs-12">
    <hr/>
    <nav>
      <ul class="pager">
        <% if @ref_num == 0 %>
          <li class="previous disabled">
            <%= link_to "<span aria-hidden='true'>&larr;</span> Previous".html_safe,
              "#", html_options: {class: "disabled"} %>
          </li>
        <% else %>
          <li class="previous">
            <%= link_to "<span aria-hidden='true'>&larr;</span> Previous".html_safe,
              references_mass_assignment_path(ref_num: @ref_num - 1) %>
          </li>
        <% end %>

        <% if @ref_num == @refs.size-1 %>
          <li class="next disabled">
            <%= link_to "Next <span aria-hidden='true'>&rarr;</span>".html_safe,
              "#", html_options: {class: "disabled", onclick: "reset_submit_listener()" } %>
          </li>
        <% else %>
          <li class="next">
            <%= link_to "Next <span aria-hidden='true'>&rarr;</span>".html_safe,
              references_mass_assignment_path(ref_num: @ref_num + 1) %>
          </li>
        <% end %>
      </ul>
    </nav>
  </div>
</div>

<%= render partial: "mass_assignment_reference", locals: { ref: @ref } %>

<div class="row top-buffer">
  <div class="col-xs-12 text-center">
    <p><b>Additional Sources</b></p>
    <p><%= link_to "http://code.tutsplus.com/tutorials/mass-assignment-rails-and-you--net-31695",
      "http://code.tutsplus.com/tutorials/mass-assignment-rails-and-you--net-31695" %></p>
    <p><%= link_to "http://www.happybearsoftware.com/how-i-avoid-the-rails-mass-assignment-security-mistake.html",
      "http://www.happybearsoftware.com/how-i-avoid-the-rails-mass-assignment-security-mistake.html" %></p>
  </div>
</div>
